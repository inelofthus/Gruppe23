<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="no"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>IME_API.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RateChill</a> &gt; <a href="index.source.html" class="el_package">api</a> &gt; <span class="el_source">IME_API.java</span></div><h1>IME_API.java</h1><pre class="source lang-java linenums">package api;

import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLEncoder;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

import database.DBController;

<span class="nc" id="L18">public class IME_API {</span>
	
<span class="nc" id="L20">	DBController dbc = new DBController();</span>
<span class="nc" id="L21">	LecturesAPI lecAPI = new LecturesAPI();</span>
	
	/**
	 * This function retrieves information about courses and lectures from two different APIs,
	 * and inserts into the database
	 */
	public void getApiInfo() throws IOException{
<span class="nc" id="L28">		String sURL = &quot;http://www.ime.ntnu.no/api/course/en/-&quot;;</span>
	    // Connect to the URL using java's native library
<span class="nc" id="L30">	    URL url = new URL(sURL);</span>
<span class="nc" id="L31">	    HttpURLConnection request = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L32">	    request.connect();</span>
	
	    // Convert to a JSON object to print data
<span class="nc" id="L35">	    JsonParser jp = new JsonParser(); //from gson</span>
<span class="nc" id="L36">	    JsonElement root = jp.parse(new InputStreamReader((InputStream) request.getContent())); //Convert the input stream to a json element</span>
<span class="nc" id="L37">	    JsonObject rootobj = root.getAsJsonObject(); //May be an array, may be an object. </span>
	    
<span class="nc" id="L39">	    JsonArray course = rootobj.getAsJsonArray(&quot;course&quot;);</span>
	    
	    
<span class="nc" id="L42">	    dbc.connect();</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">	    for (int i = 0; i &lt; course.size(); i++){</span>
	    	
<span class="nc" id="L45">	    	loadAndSetCourseInfo(course.get(i).getAsJsonObject().get(&quot;code&quot;).getAsString());</span>
	    	
	    }
<span class="nc" id="L48">	    dbc.close();</span>
<span class="nc" id="L49">	    request.disconnect();</span>

<span class="nc" id="L51">	}</span>
	
	public void loadAndSetCourseInfo(String courseCode) throws IOException{
		
<span class="nc" id="L55">	    String sURL = &quot;&quot;;</span>
		
<span class="nc bnc" id="L57" title="All 2 branches missed.">		if (courseCode.contains(&quot;/&quot;)){</span>
<span class="nc" id="L58">			sURL = &quot;http://www.ime.ntnu.no/api/course/en/&quot; + courseCode;</span>
		}else{
<span class="nc" id="L60">			sURL = &quot;http://www.ime.ntnu.no/api/course/en/&quot; + URLEncoder.encode(courseCode, &quot;utf-8&quot;);</span>
		}
	    
<span class="nc" id="L63">	    URL url = new URL(sURL);</span>
	    
<span class="nc" id="L65">	    HttpURLConnection request = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L66">	    request.connect();</span>

<span class="nc" id="L68">	    JsonParser jp = new JsonParser(); //from gson</span>
<span class="nc" id="L69">	    JsonElement root = jp.parse(new InputStreamReader((InputStream) request.getContent())); //Convert the input stream to a json element</span>
<span class="nc" id="L70">	    JsonObject rootobj = root.getAsJsonObject(); //May be an array, may be an object. </span>
	    
	    try {
<span class="nc" id="L73">		    String courseName = rootobj.getAsJsonObject(&quot;course&quot;).get(&quot;englishName&quot;).getAsString();</span>
<span class="nc" id="L74">		    int lectureHours = -1;</span>
		    try {
<span class="nc" id="L76">			    lectureHours = rootobj.getAsJsonObject(&quot;course&quot;).</span>
<span class="nc" id="L77">			    		getAsJsonArray(&quot;educationTerm&quot;).get(0).getAsJsonObject().</span>
<span class="nc" id="L78">			    		get(&quot;lectureHours&quot;).getAsInt();</span>
<span class="nc" id="L79">			} catch (Exception e) {</span>
<span class="nc" id="L80">				System.out.println(&quot;No lecture hours for this course&quot;);</span>
<span class="nc" id="L81">			}</span>
		    
<span class="nc" id="L83">		    String location = rootobj.getAsJsonObject(&quot;course&quot;).get(&quot;location&quot;).getAsString();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">		    if (!location.equals(&quot;Trondheim&quot;)){</span>
<span class="nc" id="L85">		    	throw new IllegalArgumentException();</span>
		    }
<span class="nc" id="L87">		    boolean taughtInSpring = rootobj.getAsJsonObject(&quot;course&quot;).get(&quot;taughtInSpring&quot;).getAsBoolean();</span>
<span class="nc" id="L88">		    boolean taughtInAutumn = rootobj.getAsJsonObject(&quot;course&quot;).get(&quot;taughtInAutumn&quot;).getAsBoolean();</span>
<span class="nc" id="L89">		    String professorUsername = rootobj.getAsJsonObject(&quot;course&quot;).</span>
<span class="nc" id="L90">		    		getAsJsonArray(&quot;educationalRole&quot;).get(0).getAsJsonObject().</span>
<span class="nc" id="L91">		    		get(&quot;person&quot;).getAsJsonObject().get(&quot;username&quot;).getAsString();</span>
<span class="nc" id="L92">		    dbc.insertCourseCon(courseCode, courseName, lectureHours, taughtInSpring, taughtInAutumn);</span>
<span class="nc" id="L93">		    dbc.insertProfessorCon(professorUsername, &quot;np&quot;);</span>
<span class="nc" id="L94">		    dbc.insertCourseProfessorCon(professorUsername, courseCode);</span>
	    	
<span class="nc" id="L96">		    lecAPI.getApiInfoAndInsertToDB(courseCode, professorUsername);</span>
		    
<span class="nc" id="L98">		    System.out.println(courseCode);</span>
<span class="nc" id="L99">	    } catch (IllegalArgumentException iae) {</span>
<span class="nc" id="L100">	    	System.out.println(&quot;Course not taught in Trondheim&quot;);</span>
<span class="nc" id="L101">		} catch (Exception e) {</span>
<span class="nc" id="L102">			System.out.println(&quot;One or more fields are missing&quot;);</span>
<span class="nc" id="L103">		}</span>
	    
<span class="nc" id="L105">	}</span>
	
	public static void main(String[] args) throws IOException {
<span class="nc" id="L108">		IME_API api = new IME_API();</span>
<span class="nc" id="L109">		long startTime = System.nanoTime();</span>
<span class="nc" id="L110">		api.getApiInfo();</span>
<span class="nc" id="L111">		long endTime = System.nanoTime();</span>
<span class="nc" id="L112">		System.out.println(endTime-startTime);</span>
<span class="nc" id="L113">	}</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>